%%-*-latex-*-

\documentclass[10pt]{article}

% Packages
%
\usepackage[francais]{babel}
\usepackage[latin1]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{ae,aecompl,xspace}
\usepackage{verbatim}
\usepackage{alltt}
\usepackage[nottoc]{tocbibind}

% Macros
%
\newcommand{\must}{\noindent $\triangleright$ \hspace{0.1cm}}
\newcommand{\bitem}{\item[$\bullet$]}

\input{cpp}
\input{trace}

% Header
%
\title{Introduction \`a la configuration automatique}
\author{Christian Rinderknecht \and Yann Régis-Gianas}

\begin{document}

\maketitle

\tableofcontents

\section{Introduction}

\section{Toto}
Il existe des recommandations et un ensemble d'utilitaires
\textsf{GNU} dont le but est d'aider au développement, à la
distribution et à la maintenance de logiciels portables en mode
source. En particulier, l'accent est mis sur la configuration
automatique avant la compilation. Ce sont les \textsf{Autotools}, qui
correspondent aux applications suivantes.

\begin{itemize}

  \bitem \textsf{autoconf} produit, à partir d'un fichier de
  configuration \texttt{configure.ac}, contenant des appels de macros
  \textsf{M4} et des portions de scripts \emph{shell}, un script
  \emph{shell} nommé \textsf{configure} et des fichiers de support
  supplémentaires.

  \bitem \textsf{configure} est produit par \textsf{autoconf} et son
  exécution produit un fichier \textsf{Makefile} à partir d'une
  description \texttt{Makefile.in} et des fichiers de support produits
  par \textsf{autoconf}. 

  \bitem \textsf{aclocal} est un générateur de macros \textsf{M4} en
  éventuel support du fichier de configuration \texttt{configure.ac},
  pour des cas spécifiques comme l'emploi conjoint de
  \textsf{automake}.

  \bitem \textsf{automake} est un outil pour produire automatiquement
  un fichier \texttt{Makefile.in} à partir d'une description
  \texttt{Makefile.am} composée de macros \textsf{M4} et de règles
  pour \textsf{make}, dans le but que \texttt{Makefile.in} inclue
  automatiquement des règles génériques et conformes aux standards
  \textsf{GNU}.

  \bitem \textsf{autoheader} crée, à partir de \texttt{configure.ac},
  un fichier d'en-tête~\textsf{C} contenant des directives de
  pré-compilation \verb+#define+ pour \textsf{configure} (si
  \texttt{con\-figure.ac} appelle la macro
  \texttt{AC\_CONFIG\_HEADERS(\textsf{\emph{file}}.h)} alors
  \textsf{autoheader} crée \textsf{\emph{file}}\texttt{.h.in}).

  \bitem \textsf{libtoolize} fournit un moyen standard d'ajouter le
   support de \textsf{libtool} (un script pour le support de
   bibliothèques partagées) aux applications~\textsf{C}.

  \bitem \textsf{autopoint} installe l'infrastructure de fichiers
  support à l'internationalisation (système \textsf{GNU Gettext}).

  \bitem \textsf{autoreconf} installe et exécute si besoin les
  différents outils \textsf{GNU} pour la construction d'applications
  (\textsf{autoconf}, \textsf{autoheader}, \textsf{aclocal},
  \textsf{automake}, \textsf{libtoolize} et \textsf{autopoint}) à
  chaque niveau de l'arborescence des sources. Cela peut être rendu
  nécessaire si \textsf{Automake} a été mis à jour sur le système ou
  si \texttt{configure.ac} a changé, par exemple, ou simplement pour
  créer une nouvelle arborescence.

  \bitem \textsf{autoscan} facilite la création et la maintenance du
  fichier \texttt{configure.ac}. Il examine les sources~\textsf{C}
  pour déterminer d'éventuels problèmes de portabilité et analyse
  aussi l'éventuel \texttt{configure.ac} pour en vérifier la
  complétude et produit un fichier \texttt{configure.scan} qui sert de
  canevas pour un (éventuellement nouveau) \texttt{configure.ac}.

  \bitem \textsf{autoupdate} met à jour un fichier
  \texttt{configure.ac} qui fait appel à des macros \textsf{M4} pour
  \textsf{Autoconf} dont le nom est obsolète.

\end{itemize}

\noindent Nous allons présenter quelques cas simples d'utilisation de
quelques-uns de ces utilitaires.


\section{\textsf{Autoconf}}

\textsf{Autoconf} est un outil pour produire des scripts \emph{shell}
qui configurent automatiquement des distributions logicielles en mode
source dans le but de les adapter aux nombreux types de systèmes
\textsc{Unix}. Les scripts de configuration produits par
\textsf{Autoconf} sont indépendants de ce dernier lors de leur
exécution, donc les usagers n'ont pas besoin d'avoir
\textsf{Autoconf}.

Les scripts de configuration produits par \textsf{Autoconf} ne
nécessitent aucune intervention manuelle de la part de l'usager pour
être exécutés; ils n'ont normalement même pas besoin d'un argument
spécifiant le type du système. Au lieu de cela, ils testent eux-mêmes
la présence des caractéristiques et outils dont la distribution a
besoin. (Avant chaque vérification, ils affichent un message sur une
ligne disant ce qu'ils testent.) Ainsi ils gèrent bien les systèmes
hybridés à partir des variantes communes de \textsc{Unix}. En
particulier il n'est pas besoin de maintenir des listes de
caractéristiques de chaque distribution de chaque variante de
\textsc{Unix}.

Pour chaque distribution pour laquelle \textsf{Autoconf} est employé,
ce dernier outil crée un script de configuration à partir d'un script
qui liste les caractéristiques et outils système dont la distribution
a besoin ou peut utiliser. Après que le script \emph{shell} qui
reconnaît et réagit à une caractéristique système est écrit,
\textsf{Autoconf} lui permet d'être partagé par de nombreuses
distributions qui peuvent (ou doivent) utiliser cette
caractéristique. Ainsi, si le script \emph{shell} nécessite
ultérieurement des ajustements, il n'est modifié qu'en un seul lieu et
tous les scripts de configuration peuvent être régénérés
automatiquement pour prendre en compte la mise à jour.
                        
Le script \emph{shell} de configuration produit par \textsf{Autoconf}
est nommé par convention \textsf{configure}. Quand il est exécuté,
celui-ci crée plusieurs fichiers dans lesquels les paramètres
génériques de configuration sont remplacés par les valeurs
appropriées. Ces fichiers sont:

\begin{itemize}                                                           

  \bitem un ou plusieurs makefiles, typiquement dans chaque
  sous-répertoire de la distribution;

  \bitem un ensemble de fichiers définis par l'utilisateur dans
  lesquels contenant des variables à substituer;

  \bitem optionnellement, un fichier d'en-tête~\textsf{C} dont le nom
  est configurable, contenant des directives de précompilation
  \verb+#define+;

  \bitem un script \emph{shell} nommé \texttt{config.status} qui,
  quand il sera exécuté, recréera les fichiers précédents;

  \bitem un script \emph{shell} optionnel nommé \texttt{config.cache}
  (crée par la commande \verb|configure --config-cache|) qui
  sauvegarde le résultat des tests effectués par \textsf{configure}
  pour être partagés avec d'autres scripts \textsf{configure} ou entre
  différentes exécutions du même;

  \bitem un fichier \texttt{config.log} contenant les messages émis
  par d'éventuels compilateurs dans le but d'aider au déverminage si
  \textsf{configure} commet une erreur.
                                                                          
\end{itemize}

Donc, pour créer un script \textsf{configure} avec \textsf{Autoconf}
il faut écrire un fichier d'entrée \texttt{configure.ac} et lancer
\textsf{autoconf}. Si on veut écrire ses propres tests (sous forme de
macros \textsf{M4}) pour compléter ceux proposés par défaut par
\textsf{Autoconf}, il faut les mettre dans deux fichiers
\texttt{aclocal.m4} et \texttt{acsite.m4}. Si on a besoin d'un fichier
d'en-tête~\textsf{C} (souvent nommé \texttt{config.h}) on peut alors
employer \textsf{Autoheader} et l'on distribue alors sa spécification
(souvent \texttt{config.h.in}).

Voici un diagramme tiré \emph{verbatim} du manuel de
\textsf{Autoconf}, qui montre comment les fichiers qui peuvent être
utiles à la configuration sont produits. Les programmes qui sont
exécutés sont suffixés par \verb+*+. Les fichiers optionnels
apparaissent entre crochets. À noter aussi que \textsf{autoconf} et
\textsf{autoheader} lisent aussi les macros prédéfinies de
\textsf{Autoconf} dans \texttt{autoconf.m4} (pré-installé).

\begin{itemize}

  \bitem Fichiers utilisés pour préparer la distribution du
  logiciel (côté distributeur):
  \begin{itemize}

    \bitem Si l'on ne réutilise pas un \texttt{configure.ac}, on peut
    se faire aider pour en créer un neuf à partir des sources:\\
    \emph{sources} $\longrightarrow$
    \textsf{autoscan}\texttt{*} $\longrightarrow$
    \texttt{configure.scan} $\longrightarrow$ \texttt{configure.ac}

    \bitem 
{\small
\begin{verbatim}
configure.ac --.
               |   .------> autoconf* -----> configure
[aclocal.m4] --+---+
               |   `-----> [autoheader*] --> [config.h.in]
[acsite.m4] ---'
\end{verbatim}
}

  \bitem
{\small
\begin{verbatim}
Makefile.in -------------------------------> Makefile.in
\end{verbatim}
}

  \end{itemize}

\noindent À noter qu'il faut écrire soi-même la description
\texttt{Makefile.in} du makefile pour \textsf{Autoconf}. Nous verrons
plus loin la différence avec l'emploi de \textsf{Automake}.

  \bitem Fichiers utilisés pour la configuration de la distribution
  (côté usager):
{\small
\begin{verbatim}
                       .-------------> [config.cache]
configure* ------------+-------------> config.log
                       |
[config.h.in] -.       v            .-> [config.h] -.
               +--> config.status* -+               +--> make*
Makefile.in ---'                    `-> Makefile ---'
\end{verbatim}
}   
\end{itemize}


\subsection{Pour les projets en \textsf{Objective Caml}}

\subsubsection{Le fichier \texttt{configure.ac}}

\noindent Voici un fichier \textsf{configure.ac} pour les petits
projets en Objective Caml.

{\small
\begin{alltt}
# -*-autoconf-*-

# Autoconfiguration for Objective Caml projects
# (c) 2003 Christian Rinderknecht

# Process this file with `autoconf' to produce a configure script.
\emph{[...]}
\end{alltt}
}

\noindent La première ligne est une méta-information pour
\textsf{Emacs} et les suivantes informent sur la nature du script, son
auteur et comment s'en servir.

{\small
\begin{alltt}
\emph{[...]}
# ------------------------------------------------------------------
# General settings
#
AC_INIT(Fun Calc,1.0,Christian.Rinderknecht@devinci.fr)
AC_PREREQ(2.53)
AC_CONFIG_SRCDIR(main.ml)

ac_version=$(autoconf -V | grep GNU) 

echo "Autoconfiguration of $PACKAGE_STRING"
echo "(c) 2003 Christian Rinderknecht"
echo
echo "This is $ac_version"
\emph{[...]}
\end{alltt}
}

\noindent Certaines macros\footnote{Les macros \textsf{M4} de
\textsf{Autoconf} sont toutes préfixées par «~\texttt{AC\_}~».} font
l'hypothèse que d'autres macros ont été appelées précédemment. De
plus, toute spécification \texttt{configure.ac} doit contenir un appel
à la macro \texttt{AC\_INIT} avant de procéder aux tests et doit
appeler \texttt{AC\_OUTPUT} à la fin. Le premier argument de
\texttt{AC\_INIT} est le nom du paquetage (\emph{package}), ici
\textsf{Fun Calc}, et le second son numéro de version, ici
\textsf{1.0}. Cette macro peut prendre deux arguments supplémentaires:
l'adresse électronique du mainteneur du paquetage (à contacter en cas
de problèmes) et le nom de l'archive \texttt{tar}. Par défaut, le nom
de l'archive sera celui du paquetage sans le préfixe \texttt{GNU}, mis
en minuscule et dont tous les caractères autres qu'alphanumériques et
tirets-bas sont changés en trait d'union (donc ici le nom de base de
l'archive sera \texttt{fun-calc}). Une fois qu'on aura exécuté
\textsf{autoconf}, on pourra récupérer une partie de ces informations
en exécutant
{\small
\begin{alltt}
~/TP-Autotools/Projet/OCaml$ ./configure --version
Fun Calc configure 1.0
generated by GNU Autoconf 2.57 
\emph{[...]}
~/TP-Autotools/Projet/OCaml$ ./configure --help
`configure' configures Fun Calc 1.0 to adapt to many kinds of 
systems.
 
Usage: ./configure [OPTION]... [VAR=VALUE]...
\emph{[...]}
Report bugs to <Christian.Rinderknecht@devinci.fr>.
\end{alltt}
}

\noindent On remarque en passant qu'il est de bon aloi de toujours
appeler \textsf{configure} en forçant le chemin d'accès
(\texttt{./configure}) pour éviter de fâcheux malentendus dont on se
passe volontiers durant la phase de configuration.

\medskip

\noindent On peut référencer ces arguments dans la spécification
\texttt{configure.ac} par le biais des variables \emph{shell}
prédéfinies, en suivant l'ordre d'écriture, \texttt{PACKAGE\_\-NAME},
\texttt{PACKAGE\_VERSION}, \texttt{PACKAGE\_BUGREPORT} et
\texttt{PACKAGE\_TARNAME}. On lit aussi dans notre
\texttt{configure.ac} (première commande \texttt{echo}) l'emploi de la
variable \texttt{PACKAGE\_STRING} qui vaut la concaténation de
\texttt{PACKAGE\_NAME} et de \texttt{PACKAGE\_\-VERS\-ION}.

\medskip

\noindent Ensuite (toujours après \texttt{AC\_INIT}) nous appelons la
macro \texttt{AC\_PREREQ} avec le numéro de version minimal de
\textsf{Autoconf} dont le script a besoin, ici \textsf{2.53}. Si nous
avions exigé \texttt{AC\_PREREQ(2.63)} alors que nous utilisons la
version \textsf{2.57} de \textsf{Autoconf}, voici ce qui se passe:
{\small
\begin{verbatim}
~/TP-Autotools/Projet/OCaml$ autoconf
configure.ac:10: error: Autoconf version 2.63 or higher is required
configure.ac:10: the top level
autom4te: /usr/bin/m4 failed with exit status: 1
\end{verbatim}
}

\noindent L'appel de macro suivant est
\texttt{AC\_CONFIG\_SRCDIR(main.ml)}. L'unique argument doit être un
fichier présent dans le répertoire des sources. Le script
\textsf{configure} vérifiera alors l'existence de ce
fichier. Puisqu'il faudra donner en argument à \textsf{configure} le
répertoire des sources avec l'option \verb|--srcdir|, cet argument
servira donc à détecter une éventuelle erreur avec cette option. Par
exemple, si nous saisissons

{\small
\begin{verbatim}
~/TP-Autotools/Projet/OCaml$ autoconf
~/TP-Autotools/Projet/OCaml$ ./configure --srcdir=toto
configure: error: cannot find sources (ast.ml) in toto
\end{verbatim}
}

\noindent Au passage, la variable \texttt{srcdir} est automatiquement
initialisée par \textsf{configure} avec la valeur de l'option
\verb|--srcdir| (s'il n'a en a pas, la valeur est par défaut
\texttt{.}). Ensuite nous déterminons la version courante de
\textsf{Autoconf} pour l'afficher. Pour cela nous lançons
\textsf{autoconf} avec l'option \texttt{-V}, ce qui donne par exemple:

{\small
\begin{verbatim}
~/TP-Autotools/Projet/OCaml$ autoconf -V
autoconf (GNU Autoconf) 2.53
Written by David J. MacKenzie and Akim Demaille.

Copyright 2002 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.  
There is NO warranty; not even for MERCHANTABILITY or FITNESS FOR A 
PARTICULAR PURPOSE.
\end{verbatim}
}

\noindent Nous récupérons la ligne contenant le numéro de version à
l'aide de \textsf{grep} et nous l'affichons. L'exécution de la portion
de \textsf{configure} correspondant à cela donne:

{\small
\begin{alltt}
~/TP-Autotools/Projet/OCaml$ ./configure
Generic autoconfiguration for Objective Caml projects
(c) 2003 Christian Rinderknecht

This is autoconf (GNU Autoconf) 2.53
\emph{[...]}
\end{alltt}
}

\noindent Voici la suite de la spécification dans \texttt{configure.ac}:

{\small
\begin{alltt}
\emph{[...]}
# ------------------------------------------------------------------
# Checking for files named core, core.* and *.core. 
#
# These files are deleted by the configure script (feature of
# autoconf), but core.* may be not a system core file. Hence this
# section backs up such files and prompts the user to check them.
#
core_files=$(ls core *.core core.* 2> /dev/null)
maybenot_core=$(ls core.* 2> /dev/null)

if test -n "$core_files";
then
  echo -------------------------------------------------------------
  if test $(echo $core_files | wc --words) = 1;
  then
    echo "File $core_files is going to be deleted!"
  else
    echo "Files $core_files are going to be deleted!"
  fi
  if test -n "$maybenot_core";
  then
    echo n "  => Backup of $maybenot_core in \symbol{92}
            BACKUP-$maybenot_core..."
    cp $maybenot_core BACKUP-$maybenot_core
    echo " done."
    echo "  => Rename or delete it and rerun autoconf \symbol{92}
          and configure."
  fi
fi
\emph{[...]}
\end{alltt}
}

\noindent \textsf{Autoconf} a pour particularité de supprimer d'office
tout fichier dont le nom vérifie les motifs \emph{shell} \texttt{core
*.core} et \texttt{core.*}. L'hypothèse est que ces fichiers ont été
produit par un plantage de l'application construite et donc qu'ils
sont inutiles (et encombrants). Mais il se pourrait que ce ne soit pas
le cas, en particulier si le nom de fichier a la forme
\texttt{core.*}, par exemple \texttt{core.ml}. Le but de cette portion
de script est d'éviter qu'un tel fichier soit perdu en le renommant et
en informant l'usager.

\medskip

\noindent Voyons maintenant comment spécifier la recherche des
compilateurs O'Caml.

{\small
\begin{alltt}
\emph{[...]}
echo -----------------------------------------------------------
echo Compilers

# Checking for ocaml bytecode compiler
#
AC_PATH_PROG(OCAMLC,ocamlc,none)
AC_PATH_PROG(OCAMLC_OPT,ocamlc.opt,none)
\emph{[...]}
\end{alltt}
}

\noindent La macro \textsf{M4} nommée \texttt{AC\_PATH\_PROG} prend
deux arguments obligatoires et deux optionnels. Son but, lorsqu'elle
sera expansée dans \textsf{configure}, est de rechercher parmi un
ensemble de chemins prédéfinis (et optionnellement passés en argument)
un programme. Si ce dernier est trouvé, une variable \emph{shell}
donnée est initialisée avec le nom du programme préfixé par son chemin
d'accès complet. Sinon la variable est vide ou alors prend une valeur
passée en argument de la macro. Ainsi, dans notre premier exemple, la
macro initialisera une variable \texttt{OCAMLC} en partant à la
recherche du compilateur \textsf{ocamlc}. S'il n'est pas trouvé, la
variable prendra la valeur \texttt{none}, sinon la valeur sera le
chemin d'accès complet au compilateur. Les chemins de recherche
prédéfinis sont ceux indiqués par la variable d'environnement
\texttt{PATH}. L'exécution de la portion correspondante dans
\textsf{configure} donne ici:

{\small
\begin{alltt}
~/TP-Autotools/Projet/OCaml$ ./configure
\emph{[...]}
-----------------------------------------------------------------
Compilers
checking for ocamlc... /home/der_gi/rinderkn/bin/ocamlc
checking for ocamlc.opt... /home/der_gi/rinderkn/bin/ocamlc.opt
\emph{[...]}
\end{alltt}
}

\noindent La suite de \texttt{configure.ac} est:

{\small
\begin{alltt}
\emph{[...]}
if test "$OCAMLC_OPT" = "none";
then 
  if test "$OCAMLC" != "none";
  then 
    OCAMLC_VER=`$OCAMLC -version`
    echo "  => ocamlc" v$OCAMLC_VER \symbol{92}
         "is the default compiler to byte-code"
  fi
else
  OCAMLC=$OCAMLC_OPT
  OCAMLC_VER=`$OCAMLC -version`
  echo "  => ocamlc.opt" v$OCAMLC_VER \symbol{92}
       "is the default compiler to byte-code"
fi
\emph{[...]}
\end{alltt}
}

\noindent Si les variantes du compilateur (vers le byte-code) en
byte-code et en code natif ont été trouvés\footnote{Il existe en effet
deux variantes du compilateur O'Caml vers du byte-code pour le
programmeur: une composée de byte-code et une de code natif. Cela vient
du fait que le compilateur O'Caml est autogénéré (ou
\emph{bootstrapped} en anglais), c'est-à-dire qu'il est écrit en O'Caml
lui-même.}, nous retenons celle en code natif car elle est plus rapide
et, si besoin, nous initialisons avec la variable
\texttt{OCAMLC}. Puis la version du compilateur retenu est déterminée,
stockée dans \texttt{OCAMLC\_VER} et affichée pour information. Cela
donne par exemple:

{\small
\begin{alltt}
~/TP-Autotools/Projet/OCaml$ ./configure
\emph{[...]}
  => ocamlc.opt v3.07+2 is the default compiler to byte-code
\emph{[...]}
\end{alltt}
}

\noindent La suite de \texttt{configure.ac} porte sur la recherche des
compilateurs O'Caml vers du code natif et possède la même structure:

{\small
\begin{alltt}
\emph{[...]}
# Checking for ocaml native-code compiler
#
AC_PATH_PROG(OCAMLOPT,ocamlopt,none)
AC_PATH_PROG(OCAMLOPT_OPT,ocamlopt.opt,none)

if test "$OCAMLOPT_OPT" = "none"; 
then
  if test "$OCAMLOPT" != "none";
  then
    OCAMLOPT_VER=`$OCAMLOPT -version`
    echo "  => ocamlopt" v$OCAMLOPT_VER \symbol{92}
         "is the default compiler to native-code"
  fi
else
  OCAMLOPT=$OCAMLOPT_OPT
  OCAMLOPT_VER=`$OCAMLOPT -version`
  echo "  => ocamlopt.opt" v$OCAMLOPT_VER \symbol{92}
       "is the default compiler to native-code"
fi

# Checking consistency between compilers version numbers
#
if test "$OCAMLC_VER" != "$OCAMLOPT";
then
  echo "  ** Warning: Version numbers of native" \symbol{92}
       " and byte-code compilers differ."
fi
\emph{[...]}
\end{alltt}
}

\noindent On notera la vérification d'identité entre les versions des
compilateurs natif et byte-code. Si les numéros sont différents un
avertissement est alors émis. L'exécution de cette portion de script
donne par exemple:

{\small
\begin{alltt}
~/TP-Autotools/Projet/OCaml$ ./configure
\emph{[...]}
checking for ocamlopt... /home/der_gi/rinderkn/bin/ocamlopt
checking for ocamlopt.opt... /home/der_gi/rinderkn/bin/ocamlopt.opt
  => ocamlopt.opt v3.07+2 is the default compiler to native-code
\emph{[...]}
\end{alltt}
}

\noindent La portion qui suit dans \texttt{configure.ac} est:

{\small
\begin{alltt}
\emph{[...]}
echo -----------------------------------------------------------
echo Preprocessors

AC_PATH_PROG(CAMLP4,camlp4,none)

if test "$CAMLP4" != "none";
then
  CAMLP4_VER=`$CAMLP4 -v 2>&1 \symbol{92}
               | sed -n 's|.*version* *\symbol{92}(.*\symbol{92})$|\symbol{92}1|p' `
  echo "  => camlp4" v$CAMLP4_VER "is the default preprocessor"
  if test "$OCAMLC_VER" != "$CAMLP4_VER";
  then
   echo "  ** Warning: Version numbers of ocamlc and camlp4 differ."
  fi
fi

AC_PATH_PROG(CAMLP4O,camlp4o,none)
\emph{[...]}
\end{alltt}
}

\noindent Son but est de localiser deux variantes du préprocesseur
pour O'Caml (semblable à \textsf{cpp} pour les projets en
langage~\textsf{C}) et d'afficher son numéro de version. si celui-ci
est différent de celui du compilateur O'Caml, on affiche un message
d'avertissement. La suite est:

{\small
\begin{alltt}
\emph{[...]}
echo -----------------------------------------------------------
echo Dependences finders

AC_PATH_PROG(OCAMLDEP,ocamldep,none)
AC_PATH_PROG(OCAMLDEP_OPT,ocamldep.opt,none)

if test "$OCAMLDEP_OPT" = "none";
then
  if test "$OCAMLDEP" != "none";
  then
    echo "  => ocamldep is the default dependences finder"
  fi
else
  OCAMLDEP=$OCAMLDEP_OPT
  echo "  => ocamldep.opt is the default dependences finder"
fi
\emph{[...]}
\end{alltt}
}

\noindent Son objectif est de localiser deux variantes de
\textsf{ocamldep}, l'outil de recherche de dépendances entre modules
fichiers O'Caml (semblable à \texttt{gcc -MM}). La suite de
\texttt{configure.ac} est:

{\small
\begin{alltt}
\emph{[...]}
echo -----------------------------------------------------------
echo Lexer generators

AC_PATH_PROG(OCAMLLEX,ocamllex,none)
AC_PATH_PROG(OCAMLLEX_OPT,ocamllex.opt,none)

if test "$OCAMLLEX_OPT" = "none";
then 
  if test "$OCAMLLEX" != "none";
  then
    echo "  => ocamllex is the default lexer generator"
  fi
else
  OCAMLLEX=$OCAMLLEX_OPT
  echo "  => ocamllex.opt is the default lexer generator"
fi
\emph{[...]}
\end{alltt}
}

\noindent Cette partie est dédiée à la recherche des variantes du
générateur d'analyseurs lexicaux \textsf{ocamllex}. La suite de
\texttt{configure.ac} est:

{\small
\begin{alltt}
\emph{[...]}
echo -----------------------------------------------------------
echo Parser generator

AC_PATH_PROG(OCAMLYACC,ocamlyacc,none)
\emph{[...]}
\end{alltt}
}

\noindent Cette partie recherche le générateur d'analyseurs
syntaxiques \textsf{ocamlyacc}. Elle est plus simple car il n'existe
qu'en code natif donc il n'y a pas de choix éventuel à faire entre
deux variantes. La suite de \texttt{configure.ac} est:

{\small
\begin{alltt}
\emph{[...]}
echo -----------------------------------------------------------
echo Directories and paths

if test "$OCAMLC" != "none";
then
  OCAMLLIB=`$OCAMLC -where`
  echo "  => The standard library path is" $OCAMLLIB
fi
echo "  => The source directory is" \symbol{92}'$srcdir\symbol{92}'
\emph{[...]}
\end{alltt}
}

\noindent Dans cette section de script, si un compilateur O'Caml a été
localisé nous l'interrogeons sur le lieu de la bibliothèque standard
et nous en informons l'usager. Au passage nous initialisons la
variable \texttt{OCAMLIB} avec ce répertoire. Nous rappelons aussi le
répertoire où se trouvent les fichiers sources en affichant le contenu
de la variable \texttt{srcdir} (qui a été initialisée par l'option
\verb|--srcdir| ou vaut par défaut \texttt{.}). Ensuite nous trouvons
dans \texttt{configure.ac}:

{\small
\begin{alltt}
\emph{[...]}
# ------------------------------------------------------------------
# Explicit variable substitutions
#
AC_SUBST(OCAMLC_VER)
AC_SUBST(OCAMLC)
AC_SUBST(OCAMLOPT_VER)
AC_SUBST(OCAMLOPT)
AC_SUBST(OCAMLLIB)
AC_SUBST(CAMLP4)
AC_SUBST(OCAMLDEP)
AC_SUBST(OCAMLLEX)
AC_SUBST(srcdir)
AC_SUBST(ac_version)
\emph{[...]}
\end{alltt}
}

\noindent Cette section est différente des précédentes et très
importante. Elle emploie la macro \textsf{M4} nommée
\texttt{AC\_SUBST} qui prend en argument une variable du script
(idéalement initialisée par celui-ci en fonction des résultats des
tests effectués) et qui déclare la substitution textuelle future par sa
valeur dans le fichier \emph{fichier}\texttt{.in}, où \emph{fichier}
est l'argument de la macro \texttt{AC\_CONFIG\_FILES} 
(ci-après). Typiquement, ce fichier dans lequel sont substituées les
variables est \texttt{Makefile.in} et \textsf{configure} produit à
partir de lui le fichier \texttt{Makefile}. La fin de
\texttt{configure.ac} dit:

{\small
\begin{alltt}
\emph{[...]}
echo -----------------------------------------------------------
AC_CONFIG_FILES(Makefile)
AC_OUTPUT
chmod a-w Makefile
\end{alltt}
}

\noindent C'est ici qu'on appelle donc \texttt{AC\_CONFIG\_FILES}. La
macro \texttt{AC\_OUTPUT} exécute les substitutions et la production
de \texttt{Makefile} (ici). La dernière commande assure que le
makefile produit n'est pas modifiable, car, en théorie, on ne doit pas
modifier soi-même un fichier produit automatiquement. À l'écran on
verrait:

{\small
\begin{alltt}
~/TP-Autotools/Projet/OCaml$ ./configure
\emph{[...]}
-----------------------------------------------------------------
configure: creating ./config.status
config.status: creating Makefile
\end{alltt}
}

\noindent En réalité, comme le suggère l'affichage, \textsf{configure}
produit un autre script nommé \textsf{config.status} qui, lui,
fabrique \emph{in fine} \texttt{Makefile} à partir du fichier
\texttt{Makefile.in} en réalisant les substitutions de variables
spécifiées dans le fichier \texttt{configure.ac}.

\subsubsection{Le fichier \texttt{Makefile.in}}

Dans le plus simple des cas, la différence entre un fichier
\texttt{Makefile.in} et un \texttt{Makefile} tient au fait que l'on
n'écrit pas directement dans \texttt{Makefile} les chemins vers les
programmes qui sont utilisés. Au lieu de cela, on écrit un
\texttt{Makefile.in} qui correspond à un \texttt{Makefile} habituel
mais où les variables définissant ces chemins sont destinées à être
textuellement substituées par une valeur correcte pour la plateforme
par le truchement de \textsf{configure} (plus précisément
\textsf{config.status}). Ces variables sont alors notées entre
arrobes\footnote{Il serait plus correct d'un point de vue étymologique
de dire \emph{à rond bas-de-casse} comme le font les typographes pour
désigner le symbole \symbol{64} (prononcé \emph{ad} en latin).} dans
\texttt{Makefile.in}.

Le fichier \texttt{Makefile.in} dans l'archive, associé au
\texttt{configure.ac} présenté précédemment, commence ainsi:

{\small
\begin{alltt}
# -*-makefile-*-

# Makefile for an Objective Caml project

# -----------------------------------------------------------------
# General settings
#
VPATH := src
.PHONY: clean

SRCDIR := @srcdir@
\emph{[...]}
\end{alltt}
}

\noindent La nouveauté est donc la variable \texttt{SRCDIR} dont la
valeur est textuellement définie par \textsf{config.status},
\emph{via} \textsf{configure}, en substituant \verb|@srcdir@| par la
valeur de la variable \texttt{srcdir} définie dans
\texttt{configure.ac}. En conclusion, le fichier \texttt{Makefile.in}
ne présente aucune particularité si ce n'est la définition de
variables \textsf{Make} à partir de «~variables \textsf{Autoconf}~».


\subsection{Pour les projets en \textsf{C/\cpp}}

Les langages C et \cpp{} posent beaucoup de problèmes de portabilité car
de nombreux compilateurs ont été développés depuis les années 70,
chacun suivant sa route en fonction des ses objectifs et de son
système d'exploitation. Malgré les normes ANSI pour le C, ISO pour le
\cpp et POSIX pour les appels systèmes, certaines fonctionnalités sont
donc soit absentes, soit mal implémentées. Pour gagner en
portabilité, il convient donc de:

\begin{itemize}
\bitem S'informer sur l'environnement de compilation ;
\bitem Détecter les problèmes ;
\bitem Adapter la compilation.
\end{itemize}

\subsubsection{Configuration standard pour un programme C/\cpp}

Les informations à collecter pour compiler un programme C/\cpp sont au
minimum le compilateur et les outils de création de
bibliothèque. Considérons donc le fichier de configuration minimal
suivant:
{\small
\begin{verbatim}
# Initialisation d'Autoconf.
AC_INIT(configure.ac)

# Quel est le compilateur C par défaut ?
AC_PROG_CC

# Pas de fichier de configuration ici.
AC_CONFIG_FILES([])
AC_OUTPUT
\end{verbatim}
}

Après exécution d'Autoconf, puis du configure généré, on obtient:
{\small
\begin{verbatim}
checking for gcc... gcc
checking for C compiler default output... a.out
checking whether the C compiler works... yes
checking whether we are cross compiling... no
checking for suffix of executables...
checking for suffix of object files... o
checking whether we are using the GNU C compiler... yes
checking whether gcc accepts -g... yes
checking for gcc option to accept ANSI C... none needed
configure: creating ./config.status
\end{verbatim}
}

On remarque que le premier compilateur recherché est gcc, qu'il est
bien détecté sur le système. Ensuite, configure effectue quelques
tests standards de manière à définir ses variables de configuration. 

Pour tester l'existence d'un compilateur \cpp, on utilise la macro
\texttt{AC\_PROG\_\-CXX} de façon similaire. Pour tester l'existence
de l'utilitaire \textsf{ranlib}, on utilise \texttt{AC\_PROG\_RANLIB}.

Voici donc un fichier de configuration standard pour tester un
environnement C/\cpp:
{\small
\begin{verbatim}
# Initialisation d'Autoconf.
AC_INIT(configure.ac)
AC_PROG_CC
AC_PROG_CXX
AC_PROG_RANLIB
AC_CONFIG_FILES([])
AC_OUTPUT
\end{verbatim}
}

Et l'exécution de configure donne:
{\small
\begin{verbatim}
checking for gcc... gcc
checking for C compiler default output... a.out
checking whether the C compiler works... yes
checking whether we are cross compiling... no
checking for suffix of executables...
checking for suffix of object files... o
checking whether we are using the GNU C compiler... yes
checking whether gcc accepts -g... yes
checking for gcc option to accept ANSI C... none needed
checking whether we are using the GNU C++ compiler... yes
checking whether g++ accepts -g... yes
checking for ranlib... ranlib
configure: creating ./config.status
\end{verbatim}
}

Entre autres choses, ce configure définit automatiquement les
variables \texttt{CC}, \texttt{CXX}, \texttt{CFLAGS},
\texttt{CPPFLAGS}, \texttt{CXXFLAGS}, \texttt{RANLIB}. Il est toujours
possible de forcer la valeur de ces variables en suffixant la commande
'./configure' par une affectation de la forme 'VARIABLE=VALEUR'. Par
exemple, si vous voulez utiliser la version 2.95 de gcc, qui n'est
plus la version par défaut sur les systèmes GNU/Linux, voici la
commande:

{\small
\begin{verbatim}
# ./configure CC=gcc-2.95 CFLAGS='-O3 -DNDEBUG'
\end{verbatim}
}

\subsubsection{Détection de problèmes et leurs conséquences}

Autoconf nous donne plusieurs niveaux de granularité pour tester
d'éventuels problèmes. Le principe général de fonctionnement, c'est de
générer et d'essayer de compiler un petit bout de code qui teste
précisément le point de portabilité en question. Tout d'abord, il faut
définir le langage utilisé pour ces tests, c'est le rôle de la macro
\texttt{AC\_LANG (LANGUAGE)}. Généralement, les macros de tests
suivent la forme: \texttt{NOM\_MACRO(A\_TESTER, [ACTION\_A\_FAIRE\_SI\_OK],
  [ACTION\_SINON])}.

Les actions sont de deux types:

\begin{itemize}
\bitem \textbf{Appel de macros Autoconf} comme \texttt{AC\_MSG\_RESULT},
\texttt{AC\_MSG\_NOTICE}, \texttt{AC\_MSG\_ERROR} pour informer
l'utilisateur, mais aussi toutes les macros de tests (on peut ainsi
chaîner les tests).
\bitem \textbf{Commande shell quelconque}
\end{itemize}

Pour récolter les informations et les injecter dans le programme, un
header peut-être créé à la demande par la commande
\texttt{AC\_CONFIG\_HEADER(FICHIER)}. Usuellement, on appelle ce
fichier 'config.h'.

Le premier niveau de granularité consiste à tester l'existence de
headers par la macro \texttt{AC\_CHECK\_HEADER}. Voici sa signature:
{\small
\begin{verbatim}
 - Macro: AC_CHECK_HEADER (HEADER-FILE, [ACTION-IF-FOUND],
          [ACTION-IF-NOT-FOUND], [INCLUDES = `default-includes'])
\end{verbatim}
} 

Automatiquement, cette macro définit une macro C
\texttt{HAVE\_NOM\_DU\_HEADER\_H} dans le config.h si le header
existe. Ainsi, on peut compiler conditionnellement certaines parties
du programme C/\cpp en utilisant le préprocesseur:

{\small
\begin{verbatim}
#ifdef HAVE_MYHEADER_H
# include "my_header.h"
#else
  // The function my_foo is not present, it does not matter: 
  //we just do as if it was here.
  void my_foo() { }
#endif // HAVE_MYHEADER_H
\end{verbatim}
} 

Cependant, on veut parfois un comportement plus strict, on peut alors
utiliser une action d'autoconf:

{\small
\begin{verbatim}
AC_CHECK_HEADER(my_header.h, [], [AC_MSG_ERROR([my_header.h is not
                present, I cannot compile.])])
\end{verbatim}
}

De manière analogue, on peut tester l'existence d'une bibliothèque
grâce à la macro:
{\small
\begin{verbatim}
 - Macro: AC_CHECK_LIB (LIBRARY, FUNCTION [, ACTION-IF-FOUND [,
          ACTION-IF-NOT-FOUND [, OTHER-LIBRARIES]]])
\end{verbatim}
} 

La bibliothèque est spécifiée par le nom utilisé lors de la liaison
par l'option '-l' du compilateur. Par exemple, si la bibliothèque est
la libncurses (utilisée pour contrôler les terminaux UNIX), la
commande de liaison est '-lncurses'. Donc, pour tester l'existence de
la fonction \texttt{initscr} dans cette bibliothèque:

{\small
\begin{verbatim}
AC_CHECK_LIB(ncurses, initscr)
\end{verbatim}
} 

Si la bibliothèque est bien trouvée, une macro C
\texttt{HAVE\_LIBNCURSES} est définie et la commande -lncurses est
rajoutée automatiquement à la commande d'édition des liens.

Enfin, on peut aussi générer soit-même ses propres tests pour vérifier
la bonne compilation ou/et le bon comportement de certaines fonctions
du système. Pour cela, Autoconf nous fourni les macros suivantes:

{\small
\begin{verbatim}
 - Macro: AC_COMPILE_IFELSE (INPUT, [ACTION-IF-FOUND],
          [ACTION-IF-NOT-FOUND])
 - Macro: AC_LINK_IFELSE (INPUT, [ACTION-IF-FOUND],
          [ACTION-IF-NOT-FOUND])
 - Macro: AC_RUN_IFELSE (INPUT, [ACTION-IF-FOUND],
          [ACTION-IF-NOT-FOUND], [ACTION-IF-CROSS-COMPILING])
\end{verbatim}
}

La première macro permet de tester la bonne compilation d'un
programme, par exemple, on peut tester si la fonction C 'printf' se
compile bien:
{\small
\begin{verbatim}
AC_COMPILE_IFELSE(
[
   #include <stdio.h>
   int main()
   {
      (void)printf("%d%d%f", 10, 10, 10);
   }
], 
[echo Ok, printf works.], 
[echo Ko, printf is out of order.])
\end{verbatim}
}

La seconde permet de tester si l'édition de lien se passe correctement:
{\small
\begin{verbatim}
AC_LINK_IFELSE(
[
  int getopt(int);

  int main()
  {
     (void)(getopt(1));
  }
],
[echo Ok, getopt is already present in the system C standard library.],
[echo Ko, we should use our getopt library.])
\end{verbatim}
}

Cela ne veut pas dire que 'getopt' est bien utilisée ou qu'elle
fonctionne correctement, la dernière macro permet de tester
l'exécution du programme:

{\small
\begin{verbatim}
AC_RUN_IFELSE(
[
  int getopt(int);

  int main()
  {
     (void)(getopt(1));
  }
],
[echo GetOpt does support bad use !],
[echo Ok, getopt is strict.])
\end{verbatim}
}

Pour conclure, sachez qu'il existe encore de nombreuses macros
d'Autoconf pour effectuer ce type de tests, vous les trouverez dans la
section \texttt{Existing Tests} et \texttt{Writing Tests} de la
documentation d'Autoconf (\texttt{info autoconf}).

\section{\textsf{Automake} pour les projets en \textsf{C/\cpp}}

Automake est un outil de génération de Makefile. Les Makefiles générés
fournissent des facilités pour le développement, la maintenance et la
distribution de programmes. Comme expliqué précédemment, Automake
fournit des fichiers \texttt{Makefile.in} qui sont des squelettes de
Makefile qui attendent les valeurs de configuration calculé par
configure.

Pour générer ses \texttt{Makefile.in}, \textsf{Automake} attend de
l'utilisateur qu'il lui fournisse un ensemble de
\texttt{Makefile.am}. Ces fichiers définissent de manière minimale les
informations relatives à la compilation et l'installation du logiciel.

\subsection{Exemple minimaliste}

Créons un fichier foo.c contenant:
{\small
\begin{verbatim}
#include <stdio.h>

int main()
{
  (void)printf("Hello World !\n");
}
\end{verbatim}
}

On commence par créer un fichier minimaliste de configuration,
configure.ac: {\small
\begin{verbatim}
AC_INIT(configure.ac)
AM_INIT_AUTOMAKE(foo, 0.1, [yourname@devinci.fr])
AM_CONFIG_HEADER(config.h)
AC_PROG_CC
AC_CONFIG_FILES([Makefile])
AC_OUTPUT
\end{verbatim}
} Ce programme est le plus simple qu'il soit: on veut juste le
compiler et créer un exécutable du même nom. Un \texttt{Makefile.am}
possible pour définir sa compilation est le suivant:

{\small
\begin{verbatim}
bin_PROGRAMS=foo
\end{verbatim}
}

On définit un programme qui se nomme 'foo' et qui est de la famille
des programmes binaires. Par défaut, Automake essaye de trouver un
fichier foo.c. Si on voulait spécifier précisément l'ensemble des
sources du programme, il suffirait d'utiliser la variable
\texttt{SOURCES} (on pourrait alors spécifier plusieurs fichiers 
sources) :

{\small
\begin{verbatim}
bin_PROGRAMS=foo
foo_SOURCES=foo.cc 
\end{verbatim}
}

Il créé un fichier \texttt{Makefile.in} si on lance la commande:

{\small
\begin{verbatim}
aclocal
autoheader
automake -i -a -c --foreign
\end{verbatim}
}

Vous pouvez regarder le fichier \texttt{Makefile.in}, en particulier,
on remarque l'ensemble des commandes qui seront disponibles:

{\small
\begin{verbatim}
.PHONY: CTAGS GTAGS all all-am check check-am clean clean-binPROGRAMS \
   clean-generic ctags dist dist-all dist-gzip distcheck distclean \
   distclean-compile distclean-depend distclean-generic \
   distclean-hdr distclean-tags distcleancheck distdir \
   distuninstallcheck dvi dvi-am info info-am install install-am \
   install-binPROGRAMS install-data install-data-am install-exec \
   install-exec-am install-info install-info-am install-man \
   install-strip installcheck installcheck-am installdirs \
   maintainer-clean maintainer-clean-generic mostlyclean \
   mostlyclean-compile mostlyclean-generic pdf pdf-am ps ps-am \
   tags uninstall uninstall-am uninstall-binPROGRAMS \
   uninstall-info-am
\end{verbatim}
}

Maintenant, nous pouvons lancer Autoconf pour obtenir notre configure
et lancer une compilation:

{\small
\begin{verbatim}
./configure && make
\end{verbatim}
}

Pour finir cette introduction, vous pouvez lancer la commande 'make
distcheck' qui termine son exécution par:

{\small
\begin{verbatim}
========================================
foo-0.1.tar.gz is ready for distribution
========================================
\end{verbatim}
}

Cette commande compile le programme, créé une tarball, simule son
installation et lance sa batterie de tests si elle est présente.

\subsection{Compilation et maintenance}

\subsubsection{Compilation d'une bibliothèque}

Créons un répertoire \texttt{src} dans lequel nous définissons les
fichiers suivants:
{\small
\begin{verbatim}
// display.h
void display_message();
\end{verbatim}
}

{\small
\begin{verbatim}
// display.c

#include <stdlib.h>
#include <errno.h>
#include <curses.h>
#include <error.h>
#include <unistd.h>

void display_message()
{
  int i, x, y;
  char* message = "Hello World";
  WINDOW* win = initscr();
  if (win == NULL)
    error(EXIT_FAILURE, errno, "Initialization problem.");
  y=LINES/2;
  x=(COLS-strlen(message))/2;
  mvprintw(y,x,message);
  refresh();
  sleep(2);
  (void)clear();
  (void)refresh();
  (void)endwin();
}
\end{verbatim}
}

Ces fichiers vont constituer une bibliothèque fournissant la fonction
'display\_message' appelée par notre programme foo. Automake va nous
créer cette bibliothèque:

{\small
\begin{verbatim}
noinst_LIBRARIES=libdisplay.a
libdisplay_a_SOURCES= display.c
noinst_HEADERS=display.h
\end{verbatim}
}

On remplace le PROGRAMS par LIBRARIES et déclare cette bibliothèque
comme appartenant à la famille des bibliothèques qui ne s'installent
pas: elles sont juste utilisées pour compiler le programme foo. Si on
voulait installer cette bibliothèque sur le système, il suffirait de
changer \texttt{noinst} par \texttt{lib}. Ensuite, les sources sont
définies comme pour un programme normal. On spécifie aussi l'existence
de headers -- qu'on ne désire pas installer non plus -- grâce à la
variable \texttt{HEADERS}.

Il reste à connecter ce répertoire et son \texttt{Makefile.am} au
projet. Pour cela, deux choses à faire. D'abord, définir une variables
\texttt{SUBDIRS} dans le \texttt{Makefile.am} de la racine pour lui
permettre de rentrer dans le répertoire \texttt{src}. On rajoute donc
dans le \texttt{Makefile.am} de la racine du projet:

{\small
\begin{verbatim}
SUBDIRS=src
\end{verbatim}
}

Ensuite, il faut demander à configure de générer le Makefile du
sous-répertoi\-re. On modifie donc la ligne suivante dans
\texttt{configure.ac}:
{\small
\begin{verbatim}
AC_CONFIG_FILES([Makefile] [src/Makefile])
\end{verbatim}
}

On peut relancer les Autotools grâce à la commande
\texttt{autoreconf}. Ensuite, lancer \texttt{make} à la racine permet
de compiler la bibliothèque et le programme (qui ne l'utilise toujours
pas).

\subsubsection{Compilation d'un programme}

Pour utiliser une bibliothèque définie dans le projet, il suffit
d'augmenter la variable \texttt{foo\_LDADD} par
src/libdisplay.a:

{\small
\begin{verbatim}
foo_LDADD= src/libdisplay.a
\end{verbatim}
}

Notre bibliothèque utilise la libncurses, on doit donc spécifier une
option à l'éditeur de lien. Or, la libncurses est externe à notre
projet donc son intégration dépend de la configuration, c'est à dire
de configure. Il suffit donc de tester son existence dans le
configure.ac par la macro \texttt{AC\_CHECK\_LIB} pour que l'option soit
automatiquement définie par Autoconf.

\subsubsection{Définir une batterie de tests}

Automake permet de mettre en place un système de tests unitaires
lancable à partir de make par la commande \texttt{make check}. Il
suffit simplement de définir dans une variable \texttt{TESTS},
l'ensemble des programmes de tests et ensuite de déclarer pour chacun
de ces \texttt{check\_PROGRAMS} les sources utilisés pour les
compiler. Le processus de test consiste à compiler ces programmes et à
les exécuter successivement : un test réussit ssi son status de sortie
est \texttt{EXIT\_SUCCESS}.

Par exemple, on créé un répertoire 'tests' à la racine du projet. On
définit un source 'test1.c' qui se content de faire
'exit(EXIT\_SUCCESS)'. On définit alors le \texttt{Makefile.am} de la
façon suivante:

{\small
\begin{verbatim}
TESTS=test1
check_PROGRAMS=test1
test1_SOURCES=test1.c
\end{verbatim}
}

On met à jour le \texttt{SUBDIRS} du Makefile de la racine et on
demande à configure de générer le nouveau Makefile. Ensuite, lancer
'make check' à la racine donne:

{\small
\begin{verbatim}
gcc -DHAVE\_CONFIG\_H -I. -I. -I..  -g -O2 -c `test -f 'test1.c' || echo
'./'`test1.c
gcc  -g -O2   -o test1  test1.o  -lncurses
PASS: test1
==================
All 1 tests passed
==================
\end{verbatim}
}

On peut aussi définir des tests qui ne doivent pas réussir (pensez à
un compilateur qui doit rejeter les programmes mal formés). Pour cela,
on utilise la variable \texttt{XFAIL\_TESTS}. Enfin, les programmes de tests
peuvent aussi être des scripts shell par exemple.

\subsection{Installation et distribution}

\subsubsection{Paramètres d'installation}

Grâce à 'configure', on peut spécifier l'emplacement exact où on veut
installer un logiciel : ces binaires, ses bibliothèques, ses
documentations et ses fichiers annexes (demos ...). On trouve donc des
options:

{\small
\begin{verbatim}
--bindir                 -- specify: directory
--datadir                -- specify: directory
--includedir             -- specify: directory
--infodir                -- specify: directory
--libdir                 -- specify: directory
--libexecdir             -- specify: directory
--localstatedir          -- specify: directory
--mandir                 -- specify: directory
--oldincludedir          -- specify: directory
--prefix                 -- specify: prefix directory
--program-prefix         -- specify: prefix directory
--sbindir                -- specify: directory
--sharedstatedir         -- specify: directory
--srcdir                 -- specify: directory
--sysconfdir             -- specify: directory
\end{verbatim}
}

Il y a deux types d'options : celles qui permettent de contrôler
finement les répertoires et celles qui sont plus
globables. \texttt{--prefix} est la plus intéressante car elle permet
de spécifier une racine à partir d'où on peut installer les différents
composants du programme. Par exemple, si le préfixe est '/usr', les
bibliothèques seront installées dans '/usr/lib', les binaires dans
'/usr/bin' ... etc.

configure définit donc un certain nombre de variables qui
correspondent à ces répertoires: (\texttt{\$\(bindir\)}, 
\texttt{\$\(srcdir\)},\texttt{\$\(sbindir\)},\texttt{\$\(pkgdatadir\)},
\texttt{\$\(datadir\)}...).

\subsubsection{Définition de l'installation et de la distribution}

D'une manière générale, on utilise un format de nommage des variables
pour déterminer si l'objet qu'elle réfère doit être distribué et
installé (en précisant où l'installer). Une variable se décompose donc
en quatre parties:

\begin{itemize}
\bitem \texttt{dist/no\_dist}: qui précise si l'objet doit être distribué ;
\bitem \texttt{le répertoire d'installation/no\_inst}: qui définit la cible
d'installation ou qui supprime l'installation de l'objet;
\bitem \texttt{la famille de l'objet}: \texttt{PROGRAMS},
\texttt{SCRIPTS}, \texttt{DATA}, \texttt{LIBRARIES}, \texttt{HEAD\-ERS}...
\end{itemize}

\noindent Par exemple:
{\small
\begin{alltt}
# Définit un programme à installer des /sbin
sbin_PROGRAMS=foo
# Définit un programme à ne pas installer
noinst_PROGRAMS=foo
# Définit un fichier source à ne pas distribuer:
nodist_SOURCES=foo.c
# Attention ici, le fichier sera installé dans \$\(pkgdatadir\)/ 
# et non \$\(pkgdatadir\)/html
pkgdata_DATA=html/foo.html
\end{alltt}
}

Pour voir le répertoire d'installation comme une racine, on utilise un
modificateur 'nobase':
{\small
\begin{alltt}
# Le fichier sera bien installé dans \$\(pkgdatadir\)/html
nobase_pkgdata_DATA=html/foo.html
\end{alltt}
}

On peut aussi créer ses propres répertoires:
{\small
\begin{alltt}
htmldir=\$\(pkgdatadir\)/html
html_DATA=html/foo.html
\end{alltt}
}

Enfin, lorsqu'un de vos fichiers doit juste être distribué dans la
tarball et qu'il ne fait partie d'aucune des catégories citées, on
utilise la variable \texttt{EXTRA\_DIST}:
{\small
\begin{verbatim}
EXTRA_DIST=BUGS INSTALL
\end{verbatim}
}

\subsubsection{make dist/distcheck/distclean/install}

Le but de ces commandes est d'automatiser la création de
tarball. Elles déterminent les dépendances du programme, c'est-à-dire
l'ensemble des informations nécessaires à sa compilation et les
intègrent dans la tarball. Une tarball ne contient donc pas tout ce
qui se trouve dans votre répertoire de développement, si vous voulez
rajouter un fichier, il faut le spécifier à l'aide de la variable
\texttt{EXTRA\_DIST}.

'make dist' s'occupe seulement de créer la tarball sans la
tester. 'make distcheck' lui, s'occupe en plus d'installer la tarball
avec un préfixe local au répertoire courant, compile le logiciel et
lance 'make check'. Si tout ce passe bien, il vous informe que votre
tarball est bonne à distribuer. Enfin, 'make distclean' nettoie
l'ensemble de l'arborescence de développement.

La tarball ainsi créé contient un configure qui générera un
Makefile. La commande essentielle à fournir à vos utilisateurs est
donc la suivante:
{\small
\begin{verbatim}
tar xvfz votre-tarball.tar.gz
./configure
make
make check
make install 
\end{verbatim}
}

\end{document}
